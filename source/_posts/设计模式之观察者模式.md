---
title: 设计模式之观察者模式
date: 2020-02-24 12:25:10
tags:
- 设计模式
- Java
---

**观察者模式**定义了对象之间的一对多依赖，这样一来，当一个对象改变状态时，它的所有依赖者都会收到通知并自动更新。

1. #### 本模式需要解决的问题
建立一个气象观测站，根据气象信息(温度、湿度、气压)的变化，设计多个**气象布告板**

{% asset_img 需求描述.png 需求描述 %}
<!--more-->

2. #### 未应用设计模式前

```java
interface Display {
    void update(float temp, float humidity, float pressure);
}

class DisPlay1 implements Display {
    @Override
    public void update(float temp, float humidity, float pressure) {
        System.out.println("display1:" + temp + humidity + pressure);
    }
}

class DisPlay2 implements Display {
    @Override
    public void update(float temp, float humidity, float pressure) {
        System.out.println("display2:" + temp + humidity + pressure);
    }
}

class weatherData {
    float temp;
    float humidity;
    float pressure;

    public void onChange() {
        new DisPlay1().update(temp, humidity, pressure);
        new DisPlay2().update(temp, humidity, pressure);
    }
}
```

**缺点：**
- 针对具体实现编程，回导致以后在增加或删除布告板`Display`时需要修改`WeatherData`

3. #### 应用观察者模式后

```java
/**
 * 所有观察者都必须实现
 */
interface ObserverV1 {
    void update(String temperature, String humidity, String pressure);
}

class DefaultObserver implements ObserverV1 {

    @Override
    public void update(String temperature, String humidity, String pressure) {
        System.out.println(DefaultObserver.class.toGenericString() + ":" + temperature + "   " + humidity + "   " + pressure);
    }
}

class SecondObserver implements ObserverV1 {

    @Override
    public void update(String temperature, String humidity, String pressure) {
        System.out.println(SecondObserver.class.toGenericString()+":气温是:" + temperature + ", 气压是:" + pressure);
    }
}

/**
 * 主题
 */
interface Subject {
    /**
     * 注册观察者
     */
    void registerObserver(ObserverV1 observer);

    /**
     * 取消注册观察者
     */
    void removeObserver(ObserverV1 observer);

    /**
     * 通知观察者
     */
    void notifyObservers();
}

/**
 * 天气数据
 */
class WeatherDataV1 implements Subject {

    private Set<ObserverV1> observers = new HashSet<>();

    @Override
    public void registerObserver(ObserverV1 observer) {
        observers.add(observer);
    }

    @Override
    public void removeObserver(ObserverV1 observer) {
        observers.remove(observer);
    }

    @Override
    public void notifyObservers() {
        observers.forEach(observer -> observer.update(temperature, humidity, pressure));
    }

    private String temperature;
    private String humidity;
    private String pressure;

    public void setTemperature(String temperature) {
        this.temperature = temperature;
        onKeyChanged();
    }

    public void setHumidity(String humidity) {
        this.humidity = humidity;
        onKeyChanged();
    }

    public void setPressure(String pressure) {
        this.pressure = pressure;
        onKeyChanged();
    }

    public void onKeyChanged() {
        notifyObservers();
    }
}
```

**优点：**
- 增加/删除Display时,不再需要修改WeatherData;
- 将彼岸花对部分与固定不变的部分分离

调用时：
```java
public static void main(String[] args) {
    WeatherDataV1 weatherData = new WeatherDataV1();
    DefaultObserver defaultObserver = new DefaultObserver();
    SecondObserver secondObserver = new SecondObserver();
    weatherData.registerObserver(defaultObserver);
    weatherData.registerObserver(secondObserver);
    weatherData.setTemperature("hahaha");
    weatherData.setPressure("heiheihei");
    weatherData.removeObserver(defaultObserver);
    weatherData.setHumidity("h1111");
}
```