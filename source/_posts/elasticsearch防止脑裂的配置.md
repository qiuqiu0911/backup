---
title: elasticsearch防止脑裂的配置
date: 2019-08-02 11:19:49
tags: 
  - elasticsearch
  - 运维
---
1. ### 什么是脑裂
  Elasticsearch不仅仅是 Lucene，并且也不仅仅只是一个全文搜索引擎。它可以被下面这样准确的形容：
 - 一个分布式的实时文档存储，每个字段 可以被索引与搜索
 - 一个分布式实时分析搜索引擎
 - 能胜任上百个服务节点的扩展，并支持 PB 级别的结构化或者非结构化数据。

 正常情况下，es集群中只有一个主节点，主节点负责管理整个集群，集群的所有节点都会选择同一个节点作为主节点所以无论访问那个节点都可以查看集群的状态信息。而`脑裂`就是指集群中从节点在选择主节点时出现了分歧，导致集群中出现了多个主节点。这样的脑裂状态直接让节点失去了集群的正确状态，导致集群不能正常工作，也会产生数据不一致的情况。
2. ### 脑裂产生的可能原因
 - 网络问题：集群间的网络延迟导致一些节点访问不到master，认为master挂掉了从而选举出新的master，并对master上的分片和副本标红，分配新的主分片
 - 节点负载：主节点的角色既为master又为data，访问量较大时可能会导致ES停止响应造成大面积延迟，此时其他节点得不到主节点的响应认为主节点挂掉了，会重新选取主节点。
 - 内存回收：data节点上的ES进程占用的内存较大，引发JVM的大规模内存回收，造成ES进程失去响应。
3. ### 防止脑裂的相关配置
 Elasticsearch中内建的**Zen发现机制**
 - **多播**:也叫组播，指一个节点可以向多台机器发送请求。ES 不建议生产环境使用这种方式，对于一个大规模的集群，组播会产生大量不必要的通信。
 - **单播**:一个节点加入一个现有集群，或者组建一个新的集群时，发送请求到一台主机。当一个节点联系到单播列表中的成员时，它就会得到整个集群所有节点的状态，然后它会联系 master 节点，并加入集群。

 {% codeblock lang:yaml %}
 discovery.zen.minimum_master_nodes: 2
 discovery.zen.ping.multicast.enabled: false
 discovery.zen.ping.unicast.hosts: ["localhost:9300","localhost:9301","localhost:9302"]
 {% endcodeblock %}
`minimum_master_nodes`建议配置为`(具有master资格的节点的数量/2)+1`